<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>آية اليوم</title>
    <script src="html2canvas.min.js"></script>
    <style>
        :root { --primary: #FFB300; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Arial', sans-serif;
            background: white url('fds.png') no-repeat center center;
            background-size: cover; overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white url('fdss.png') no-repeat center center;
            background-size: cover; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }

        .theme-bar {
            position: absolute; top: 60px; display: flex; gap: 10px;
            background: rgba(255, 255, 255, 0.5); padding: 10px 15px;
            border-radius: 25px; backdrop-filter: blur(5px); z-index: 10;
        }

        .dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid white; }

        .verse-card {
            width: 320px; background: rgba(255, 255, 255, 0.95); border-radius: 25px;
            padding: 40px 20px; text-align: center; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .quote-icon {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            width: 50px; height: 50px; background: var(--primary); border-radius: 15px;
            display: flex; align-items: center; justify-content: center; color: white;
        }

        .verse-text { font-size: 20px; font-weight: bold; color: #333; line-height: 1.6; margin: 15px 0; }
        .quran-bracket { color: var(--primary); font-size: 24px; }
        .verse-source { font-size: 14px; color: var(--primary); margin-top: 10px; font-weight: bold; }

        .controls { margin-top: 40px; display: flex; gap: 25px; }
        .btn-action {
            width: 60px; height: 60px; background: white; border: none; border-radius: 50%;
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer;
        }
        .btn-action.primary { background: var(--primary); color: white; }
        svg { width: 25px; height: 25px; fill: currentColor; }
    </style>
</head>
<body>

    <div id="splash-screen"></div>

    <div class="theme-bar">
        <div class="dot" style="background: #FFB300;" onclick="changeTheme('#FFB300')"></div>
        <div class="dot" style="background: #2E7D32;" onclick="changeTheme('#2E7D32')"></div>
        <div class="dot" style="background: #1565C0;" onclick="changeTheme('#1565C0')"></div>
        <div class="dot" style="background: #C62828;" onclick="changeTheme('#C62828')"></div>
        <div class="dot" style="background: #000000;" onclick="changeTheme('#000000')"></div>
    </div>

    <div id="captureArea">
        <div class="verse-card">
            <div class="quote-icon" id="theme-bg1"><svg viewBox="0 0 448 512"><path d="M0 216C0 149.7 53.7 96 120 96h8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8c-39.8 0-72 32.2-72 72v24h80c26.5 0 48 21.5 48 48v128c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V216zm256 0c0-66.3 53.7-120 120-120h8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8c-39.8 0-72 32.2-72 72v24h80c26.5 0 48 21.5 48 48v128c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V216z"/></svg></div>
            <div class="verse-text">
                <span class="quran-bracket">﴿</span><span id="ayah">...</span><span class="quran-bracket">﴾</span>
            </div>
            <div class="verse-source" id="source">...</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-action" onclick="loadVerse()"><svg viewBox="0 0 512 512"><path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg></button>
        <button class="btn-action primary" id="theme-bg2" onclick="saveImage()"><svg viewBox="0 0 512 512"><path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/></svg></button>
    </div>

    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <script>
        const { Filesystem, Directory, StatusBar, Style } = Capacitor.Plugins;

        async function initApp() {
            try {
                // إجبار شريط الحالة على اللون الأبيض مع أيقونات سوداء
                await StatusBar.setStyle({ style: Style.Light });
                await StatusBar.setBackgroundColor({ color: '#FFFFFF' });
            } catch(e) {}
            
            setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 2500);
            loadVerse();
        }

        function changeTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            document.getElementById('theme-bg1').style.backgroundColor = color;
            document.getElementById('theme-bg2').style.backgroundColor = color;
            const elements = document.querySelectorAll('.quran-bracket, .verse-source');
            elements.forEach(el => el.style.color = color);
        }

        async function loadVerse() {
            try {
                const res = await fetch('quran.txt');
                const data = await res.json();
                const s = data[Math.floor(Math.random() * data.length)];
                const v = s.verses[Math.floor(Math.random() * s.verses.length)];
                document.getElementById('ayah').innerText = v.text;
                document.getElementById('source').innerText = `سورة ${s.name} - آية ${v.id}`;
            } catch(e) { document.getElementById('ayah').innerText = "تأكد من وجود ملف quran.txt"; }
        }

        async function saveImage() {
            try {
                // طلب الصلاحية برمجياً قبل الحفظ
                if (Capacitor.getPlatform() === 'android') {
                    const status = await Filesystem.requestPermissions();
                    if (status.publicStorage !== 'granted') {
                        alert("يجب إعطاء صلاحية التخزين من إعدادات الهاتف لتتمكن من حفظ الصور");
                        return;
                    }
                }

                const canvas = await html2canvas(document.getElementById('captureArea'), { scale: 3, backgroundColor: null });
                const base64Data = canvas.toDataURL("image/png").replace(/^data:image\/png;base64,/, "");
                
                const fileName = `Ayah_${Date.now()}.png`;
                await Filesystem.writeFile({
                    path: fileName,
                    data: base64Data,
                    directory: Directory.Documents,
                    recursive: true
                });
                alert("تم الحفظ بنجاح في مجلد المستندات: " + fileName);
            } catch (e) {
                console.error(e);
                alert("خطأ في الحفظ: " + e.message);
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>
